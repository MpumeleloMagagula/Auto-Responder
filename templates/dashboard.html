{% extends "base.html" %}

{% block title %}Dashboard - InfinityWork Support Desk{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Support Ticket Dashboard</h1>
    <p class="text-gray-600">Manage and review AI-generated support responses</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-6 text-center">
        <div class="text-3xl font-bold text-gray-800">{{ stats.total }}</div>
        <div class="text-gray-500 text-sm">Total Tickets</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center border-l-4 border-yellow-500">
        <div class="text-3xl font-bold text-yellow-600">{{ stats.pending }}</div>
        <div class="text-gray-500 text-sm">Pending Approval</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center border-l-4 border-green-500">
        <div class="text-3xl font-bold text-green-600">{{ stats.approved }}</div>
        <div class="text-gray-500 text-sm">Approved</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center border-l-4 border-indigo-500">
        <div class="text-3xl font-bold text-indigo-600">{{ stats.sent }}</div>
        <div class="text-gray-500 text-sm">Sent</div>
    </div>
    <div class="bg-white rounded-lg shadow p-6 text-center border-l-4 border-red-500">
        <div class="text-3xl font-bold text-red-600">{{ stats.rejected }}</div>
        <div class="text-gray-500 text-sm">Rejected</div>
    </div>
</div>

<div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-ticket-alt mr-2 text-indigo-600"></i>All Tickets
        </h2>
        <button onclick="fetchEmails()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
            <i class="fas fa-sync-alt mr-2"></i>Fetch New Emails
        </button>
    </div>
    
    {% if tickets %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ticket ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sender</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Urgency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for ticket in tickets %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-indigo-600">{{ ticket.ticket_id }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 max-w-xs truncate">{{ ticket.email_subject }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">{{ ticket.sender_email }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">
                            {{ ticket.category or 'N/A' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if ticket.urgency %}
                        <span class="px-2 py-1 text-xs rounded-full urgency-{{ ticket.urgency|lower }}">
                            {{ ticket.urgency }}
                        </span>
                        {% else %}
                        <span class="text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full status-{{ ticket.status }}">
                            {{ ticket.status | replace('_', ' ') | title }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else 'N/A' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="/ticket/{{ ticket.ticket_id }}" class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-eye mr-1"></i>View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-12 text-center text-gray-500">
        <i class="fas fa-inbox text-6xl mb-4 text-gray-300"></i>
        <p class="text-xl">No tickets yet</p>
        <p class="mt-2">Create a test ticket or configure email settings to fetch emails.</p>
        <div class="mt-4 space-x-4">
            <a href="/test-ticket" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-plus-circle mr-2"></i>Create Test Ticket
            </a>
            <a href="/settings" class="inline-block bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-cog mr-2"></i>Configure Email
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
async function fetchEmails() {
    try {
        const response = await fetch('/fetch-emails', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`Fetched ${data.processed} new emails. ${data.errors.length > 0 ? 'Some errors occurred.' : ''}`);
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Failed to fetch emails: ' + error.message);
    }
}
</script>
{% endblock %}
